#!/bin/sh
. `dirname $0`/config;

boxeehack_start()
{
    mkdir -p ${_MODULES};
    if [ -z "$1" ];
    then
        echo "Starting all modules";
        for module in ${PERSISTENTDIR}/modules-enabled/*;
        do
            CONFIG=${INSTALLDIR}/config ${module} start &
        done;

    elif [ -x "${PERSISTENTDIR}/modules-enabled/$1" ];
    then
        echo "Starting $1 module.";
        CONFIG=${INSTALLDIR}/config ${PERSISTENTDIR}/modules-enabled/$1 start;

    else
        echo "Invalid module!";
        exit 5;
    fi;
}

boxeehack_stop()
{
    if [ -z "$1" ];
    then
        echo "Stopping all modules";
        for module in ${PERSISTENTDIR}/modules-enabled/*;
        do
            CONFIG=${INSTALLDIR}/config ${module} stop;
        done;

    elif [ -x "${PERSISTENTDIR}/modules-enabled/$1" ];
    then
        echo "Stopping $1 module.";
        CONFIG=${INSTALLDIR}/config ${PERSISTENTDIR}/modules-enabled/$1 stop;

    else
        echo "Invalid module!";
        exit 6;
    fi;
}

boxeehack_install()
{
    echo "Installing Boxee+Hacks";
    mkdir -p ${PERSISTENTDIR}/modules-available;
    mkdir -p ${PERSISTENTDIR}/modules-enabled;
    mkdir -p ${PERSISTENTDIR}/bin;
    chmod +x ${INSTALLDIR}/bin/* ${PERSISTENTDIR}/bin/*;
    chmod +x ${INSTALLDIR}/modules-available/* ${PERSISTENTDIR}/modules-available/*;
    # re-enabling before enabled modules
    for module in ${PERSISTENTDIR}/modules-enabled/*;
    do
        echo "Enabling ${module}...";
        CONFIG=${INSTALLDIR}/config ${module} enable;
    done;

    # enabling default modules
    for module in ${DEFAULT_MODULES};
    do
        echo "Enabling ${module}...";
        boxeehack_module_enable ${module};
    done;

    cp -aR ${INSTALLDIR}/data/advancedsettings.xml /data/.boxee/UserData/;
    sed -i 's/"hostname":"\([^;]*\);.*","p/"hostname":"\1","p/g' /data/etc/boxeehal.conf;
    sed -i 's/<hostname>\([^;]*\);.*<\/hostname>/<hostname>\1<\/hostname>/g' /data/.boxee/UserData/guisettings.xml;
    sed -i "s%\",\"password%; sh ${INSTALLDIR}/boxeehack start;\",\"password%g" /data/etc/boxeehal.conf;
    sed -i "s%</hostname>%; sh ${INSTALLDIR}/boxeehack start;\</hostname>%g" /data/.boxee/UserData/guisettings.xml;
    touch /data/etc/boxeehal.conf;
    touch /data/.boxee/UserData/guisettings.xml;

    echo "Adding missing dropbear links..."
    for name in dbclient dropbear dropbearkey;
    do
        ln -s dropbearmulti /data/hack/bin/${name};
    done;

    echo "Adding missing busybox links..."
    for name in ftpd login passwd scp tcpsvd telnetd;
    do
        ln -s busybox /data/hack/bin/${name};
    done;

    echo "Boxee+Hacks installed!";
}

boxeehack_uninstall()
{
    echo "Uninstalling Boxee+Hacks";
    for module in ${PERSISTENTDIR}/modules-enabled/*;
    do
        echo "Disabling ${module}...";
        CONFIG=${INSTALLDIR}/config ${module} stop;
        CONFIG=${INSTALLDIR}/config ${module} disable;
    done;

    rm /data/.boxee/UserData/advancedsettings.xml;
    sed -i 's/"hostname":"\([^;]*\);.*","p/"hostname":"\1","p/g' /data/etc/boxeehal.conf;
    sed -i 's/<hostname>\([^;]*\);.*<\/hostname>/<hostname>\1<\/hostname>/g' /data/.boxee/UserData/guisettings.xml;
    touch /data/etc/boxeehal.conf;
    touch /data/.boxee/UserData/guisettings.xml;

    echo "Boxee+Hacks uninstalled!";
}

boxeehack_module_enable()
{
    if [ -z "$1" ];
    then
        echo "Module name required!";
        exit 1;
    fi;

    if [ ! -x "${INSTALLDIR}/modules-available/$1" ] && [ ! -x "${PERSISTENTDIR}/modules-available/$1" ];
    then
        echo "Module '$1' doesn't exist!";
        exit 2;
    fi;

    if [ -x "${PERSISTENTDIR}/modules-enabled/$1" ];
    then
        echo "Module '$1' already enabled!";
        exit 3;
    fi;

    if [ -x "${INSTALLDIR}/modules-available/$1" ];
    then
        ln -s ${INSTALLDIR}/modules-available/$1 ${PERSISTENTDIR}/modules-enabled/;
    elif [ -x "${PERSISTENTDIR}/modules-available/$1" ];
    then
        ln -s ${PERSISTENTDIR}/modules-available/$1 ${PERSISTENTDIR}/modules-enabled/;
    fi;

    CONFIG=${INSTALLDIR}/config ${PERSISTENTDIR}/modules-enabled/$1 enable;
}

boxeehack_module_disable()
{
    if [ -z "$1" ];
    then
        echo "Module name required!";
        exit 1;
    fi;

    if [ ! -x "${INSTALLDIR}/modules-available/$1" ] && [ ! -x "${PERSISTENTDIR}/modules-available/$1" ];
    then
        echo "Module '$1' doesn't exist!";
        exit 2;
    fi;

    if [ ! -x "${PERSISTENTDIR}/modules-enabled/$1" ];
    then
        echo "Module '$1' not enabled!";
        exit 4;
    fi;

    CONFIG=${INSTALLDIR}/config ${PERSISTENTDIR}/modules-enabled/$1 stop;
    CONFIG=${INSTALLDIR}/config ${PERSISTENTDIR}/modules-enabled/$1 disable;
    rm ${PERSISTENTDIR}/modules-enabled/$1;
}

case "$1" in
    start)
        boxeehack_start $2;
    ;;

    stop)
        boxeehack_stop $2;
    ;;

    install)
        boxeehack_install;
    ;;

    uninstall)
        boxeehack_uninstall;
    ;;

    enable)
        boxeehack_module_enable $2;
    ;;

    disable)
        boxeehack_module_disable $2;
    ;;
esac;
